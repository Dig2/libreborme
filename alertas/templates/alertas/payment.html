{% extends "alertas/base_dashboard.html" %}
{% load staticfiles %}

{% block content %}

        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">

          {% for message in messages %}
            <div class="alert alert-{{ message.tags }}" role="alert">
              {{ message }}
            </div>
          {% endfor %}

          <h1 class="page-header">Métodos de pago</h1>

            <div class="col-sm-6">
            {% if not customer.can_charge %}
              <p>No tienes ningún método de pago válido.</p>
            {% else %}
            <p><strong>Tarjetas de crédito disponibles</strong></p>
                <div class="form-group">

                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                      </tr>
                    </thead>
                    <tbody>
                    {% for card in cards %}
                      <tr>
                        <td>
                          <p>
                          <img src="/static/card_{{ card.brand }}.png" width=42 height=26>
                          <strong>{{ card.name }}</strong> xxxx-<strong>{{ card.last4 }}</strong>
                          </p>
                          <p>
                           Caduca en <strong>{{ card.exp_month | stringformat:"02d" }}/{{ card.exp_year }}</strong>  •
                           Añadida el <strong>{{ card.djstripe_created|date:"d/m/y" }}</strong>
                          </p>
                        </td>
                        <td>
                          {% if card.stripe_id == customer.default_source_id %}
                            <span title="Predeterminada" class="glyphicon glyphicon-check" aria-hidden="true"></span> Predeterminada
                          {% endif %}
                        </td>
                        <td>
                          <a class="remove_card" id="{{ card.stripe_id }}">
                            <button type="button" class="btn btn-danger btn-xs">
                              <span class="glyphicon glyphicon-trash" aria-hidden="true"></span> Eliminar
                            </button>
                          </a>
                          {% if card.stripe_id != customer.default_source_id %}
                            <a class="set_default_card" id="{{ card.stripe_id }}">
                              <button type="button" class="btn btn-primary btn-xs">
                                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Predeterminada
                              </button>
                            </a>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                    </tbody>
                  </table>
                </div>

            {% endif %}

              <form action="{% url 'alertas-settings-stripe' %}" method="POST">
                {% csrf_token %}
                <script
                  src="https://checkout.stripe.com/checkout.js" class="stripe-button"
                  data-key="{{ STRIPE_PUBLIC_KEY }}"
                  data-email="{{ customer.email }}"
                  data-zip-code="true"
                  data-billing-address="true"
                  data-image="https://stripe.com/img/documentation/checkout/marketplace.png"
                  data-name="Libreborme"
                  data-panel-label="Añadir"
                  data-label="Añadir tarjeta de crédito"
                  data-allow-remember-me=false
                  data-currency="eur"
                  data-locale="auto">
                </script>
              </form>
              <p class="help-block">
              Usamos <a href="https://stripe.com/es" target="_blank">Stripe</a>
              como pasarela de pago. LibreBORME no almacena los datos de su tarjeta.</p>
            </div>

        </div>
{% endblock %}


{% block extrastyles %}
    <link href="{% static "css/dashboard_form.css" %}" rel="stylesheet">
{% endblock %}

{% block extrajs %}
  <script src="{% static "jquery-ui-1.12.1.custom/jquery-ui.js" %}"></script>
  <script src="{% static "js/libreborme.js" %}"></script>
  <script src="{% static "jquery.cookie.js" %}"></script>

  <script>
    function remove_card(cardId) {
      AjaxRequest("{% url 'remove_card' %}?cardId=" + cardId, function (res) {
        setTimeout(location.reload(), 3000);
      }, "post", null);
    }

    function set_default_card(cardId) {
      AjaxRequest("{% url 'set_default_card' %}?cardId=" + cardId, function (res) {
        setTimeout(location.reload(), 3000);
      }, "post", null);
    }

    $("a.remove_card").click(function(ev) {
      var cardid = $(ev.currentTarget).attr("id");
      remove_card(cardid);
    });
    $("a.set_default_card").click(function(ev) {
      var cardid = $(ev.currentTarget).attr("id");
      set_default_card(cardid);
    });

  </script>
{% endblock %}
