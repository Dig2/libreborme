{% extends "alertas/base_dashboard.html" %}
{% load staticfiles %}
{% load bootstrap %}

{% block content %}

        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
          <div id="messages"></div>
          <h1 class="page-header">Listado de Alertas</h1>

          <p>Aquí puedes definir tus alertas de LibreBORME.</p>
          <p>A continuación se detallan los límites asociados a tu tipo de cuenta <strong>{{ user.profile.get_account_type_display }}</strong>:</p>
          <div class="col-sm-3">
            <table class="table">
              <thead>
                <tr>
                  <th>Tipo de alerta</th>
                  <th>Alertas máximas</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Personas y empresas</td>
                  <td>{{ limite_f }}</td>
                </tr>
                <tr>
                  <td>Actos mercantiles</td>
                  <td>{{ limite_a }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="row placeholders">

          </div>

          <h2 class="sub-header">Alertas de personas y empresas</h2>
          {% if restantes_f > 0 %}
              <p>Dispones aún de {{ restantes_f }} alertas. <a href="#" data-toggle="modal" data-target="#alerta-follow-modal">Añade una alerta nueva</a>.</p>
          {% else %}
              <p>Has agotado todas tus alertas
              {% include 'upgrade_button.html' %}
              </p>
          {% endif %}
          {% if followers %}
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Tipo</th>
                    <th>Nombre</th>
                    <th>Última actualización</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                {% for follower in followers %}
                  <tr>
                    <td class="follow-type">{{ follower.type }}</td>
                    <td><a target="_blank" href="{{ follower.get_absolute_url }}">{{ follower.slug }}</a></td>
                    <td>{{ follower.last_update }}</td>
                    <td>
                      <button type="button" class="btn btn-danger btn-xs unfollow-company" data="{{ follower.slug }}">
                        <span class="glyphicon glyphicon-trash" aria-hidden="true"></span> Eliminar
                      </button>
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>

            </div>
          {% else %}
              <p>Aún no sigues a ninguna persona ni empresa. <a href="#" data-toggle="modal" data-target="#alerta-follow-modal">Añade una alerta nueva</a>.</p>
          {% endif %}

          <h2 class="sub-header">Alertas de actos mercantiles</h2>
          {% if restantes_a > 0 %}
            <p>Dispones aún de {{ restantes_a }} alertas. <a href="#" data-toggle="modal" data-target="#alerta-acto-modal">Añade una alerta nueva</a>.</p>
          {% else %}
            <p>Has agotado todas tus alertas
            {% include 'upgrade_button.html' %}
            </p>
          {% endif %}
          {% if alertas_a %}
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Tipo de evento</th>
                  <th>Provincia</th>
                  <th>Periodicidad</th>
                  <th>Enviar HTML</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
              {% for alerta in alertas_a %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>{{ alerta.get_evento_display }}</td>
                  <td>{{ alerta.get_provincia_display }}</td>
                  <td>{{ alerta.get_periodicidad_display }}</td>
                  <td>{% if alerta.send_html %}
                    <span class="glyphicon glyphicon-ok" aria-hidden="true"></span>
                    {% else %}
                    <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                    {% endif %}
                  </td>
                  <td>
                    {% comment %}
                    <button type="button" class="btn btn-primary btn-xs">
                      <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span> Editar
                    </button>
                    {% endcomment %}
                    <a href="{% url 'alerta-remove-acto' alerta.id %}">
                    <button type="button" class="btn btn-primary btn-xs">
                      <span class="glyphicon glyphicon-trash" aria-hidden="true"></span> Eliminar
                    </button>
                    </a>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
            {% if restantes_a > 0 %}
              <p>Aún no tienes configurada ninguna alerta. <a href="#" data-toggle="modal" data-target="#alerta-acto-modal">Añade una alerta nueva</a>.</p>
            {% endif %}
          {% endif %}

        </div>

<div class="modal fade" id="alerta-follow-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="loginmodal-container">
      <form action="#" role="form" method="post">
        <legend>Añadir una nueva Alerta</legend>
          {% csrf_token %}
          {{ form_f|bootstrap }}
          <div class="form-group">
            <input type="submit" name="create" class="login loginmodal-submit" value="Crear">
          </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="alerta-acto-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="loginmodal-container">
      <form action="{% url "alertas-new-acto" %}" role="form" method="post">
        <legend>Añadir una nueva Alerta</legend>
          {% csrf_token %}
          {{ form_a|bootstrap }}
          <div class="form-group">
            <input type="submit" name="create" class="login loginmodal-submit" value="Crear">
          </div>
      </form>
    </div>
  </div>
</div>

<div style="display: none" id="sample-alert">
  <div class="alert fade in" role="alert">
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
</div>


{% endblock %}

{% block extrastyles %}
    <link href="{% static "css/dashboard_form.css" %}" rel="stylesheet">
    <link href="{% static "jquery-ui-1.12.1.custom/jquery-ui.css" %}" rel="stylesheet" >
{% endblock %}

{% block extrajs %}
  <script src="{% static "jquery-ui-1.12.1.custom/jquery-ui.js" %}"></script>
  <script src="{% static "alertas.js" %}"></script>
  <script src="{% static "follow.js" %}"></script>

  <script>
    $(".unfollow-company").click(function(ev) {
      var button = $(ev.currentTarget);
      var slug = $(button).attr("data");
      var type = $(button).parent().parent().children('td.follow-type').text();
      var csrftoken = getCookie('csrftoken');
      configCsrf(csrftoken);

      $.ajax({
        method: "POST",
        url: "{% url 'borme-ajax-follow' %}",
        data: {slug: slug, type: type}
      })
      .done(function(xhr, textStatus) {
        var resp = $.parseJSON(xhr);
        if ((typeof resp.following !== 'undefined') && (!resp.following)) {
          var link = $('a:contains("' + resp.slug + '")').filter(function(index) {
              return $(this).text() === resp.slug;
          });
          link.parent().parent().remove();
        }

        var message = $("#sample-alert").children('div').clone();
        message.addClass("alert-success");
        message.prepend('Se ha borrado la alerta para <a href="#" class="alert-link">' + resp.slug + '</a>');
        $("#messages").append(message);
      })
      .fail(function(xhr) {
      })
      .always(function(xhr, textStatus) {
      });

    });
  </script>
{% endblock %}
