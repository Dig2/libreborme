image: docker:18.09

services:
  - docker:dind

variables:
  CONTAINER_IMAGE: registry.gitlab.com/libreborme/libreborme
  CONTAINER_TEST_IMAGE: $CONTAINER_IMAGE:$CI_BUILD_REF_NAME
  DEPLOY_PATH: /opt/libreborme
  DOCKER_DRIVER: overlay
  DOCKER_HOST: tcp://localhost:2375

  POSTGRES_HOST: postgres-postgresql.libreborme-6554539.svc.cluster.local
  POSTGRES_DB: libreborme
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: iul6RBi9DP
  DJANGO_SETTINGS_MODULE: libreborme.settings_ci
  ENV_TYPE: ci
  ELASTICSEARCH_URI: http://elasticsearch-client.libreborme-6554539.svc:9200


stages:
  - build
  - test
  - release
  - deploy


build:
  stage: build
  cache:
    paths:
    - /root/
  tags:
    - kubernetes
  script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
    - docker build -t $CONTAINER_TEST_IMAGE .
    - docker push $CONTAINER_TEST_IMAGE
    # - cd docker/nginx && docker build -t registry.gitlab.com/libreborme/libreborme/nginx:$CI_BUILD_REF_NAME .
    # - docker push registry.gitlab.com/libreborme/libreborme/nginx:$CI_BUILD_REF_NAME

test:
  stage: test
  tags:
    - kubernetes
  script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
    - docker pull $CONTAINER_TEST_IMAGE
    # - docker-compose -f docker-compose.ci.yml -p ci up --abort-on-container-exit
    - docker run $CONTAINER_TEST_IMAGE bash -c "make test_ci"
  coverage: '/TOTAL.*?(\d{1,2}.\d+%)/'


release_stg:
  stage: release
  tags:
    - kubernetes
  only:
    - staging
  script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
    - docker tag $CONTAINER_TEST_IMAGE $CONTAINER_IMAGE:staging
    - docker push $CONTAINER_IMAGE:staging
    # - docker tag registry.gitlab.com/libreborme/libreborme/nginx:$CI_BUILD_REF_NAME registry.gitlab.com/libreborme/libreborme/nginx:staging
    # - docker push registry.gitlab.com/libreborme/libreborme/nginx:staging


deploy_stg:
  stage: deploy
  tags:
    - kubernetes
  only:
    - staging
  environment:
    name: staging
    url: http://staging.ingress.libreborme.net
  script:
    - echo "Hello"
    - kubectl set image deployment/libreborme libreborme-container=libreborme:staging
    - kubectl rollout status deployment/libreborme
